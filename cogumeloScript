<?php

require_once( COGUMELO_LOCATION.'/coreClasses/CogumeloClass.php' );
require_once( APP_BASE_PATH.'/Cogumelo.php' );

global $COGUMELO_IS_EXECUTING_FROM_SCRIPT;
$COGUMELO_IS_EXECUTING_FROM_SCRIPT=true;

global $_C;
$_C =Cogumelo::get();

//
// Load the necessary modules
//
require_once( ModuleController::getRealFilePath('devel.php', 'devel') );
require_once( ModuleController::getRealFilePath('classes/controller/DevelDBController.php', 'devel') );
require_once( ModuleController::getRealFilePath('classes/controller/CacheUtilsController.php', 'mediaserver') );
Cogumelo::load('coreController/ModuleController.php');


if( empty( $_SERVER['DOCUMENT_ROOT'] ) ) {
  $_SERVER['DOCUMENT_ROOT'] = ( defined( 'WEB_BASE_PATH' ) ) ? WEB_BASE_PATH : getcwd().'/httpdocs';
  echo( "\nSet SERVER[DOCUMENT_ROOT] = ".$_SERVER['DOCUMENT_ROOT']."\n" );
}


if( $argc > 1 ) {
  //parameters handler
  switch( $argv[1] ) {
    case 'setPermissions': // set the files/folders permission
      setPermissions();
      break;

    case 'setPermissionsDevel': // set the files/folders permission
      setPermissionsDevel();
      break;

    case 'generateModel':
      setPermissionsDevel();
      createRelSchemes();
      generateModel();
      flushAll();
      break;

    case 'deploy':
      setPermissionsDevel();
      createRelSchemes();
      deploy();
      flushAll();
      break;


    case 'createDB': // create database
      doBackup(Cogumelo::getSetupValue( 'db:name' ), Cogumelo::getSetupValue( 'db:user' ), Cogumelo::getSetupValue( 'db:password' ), false);
      createDB();
      break;


    case 'bckDB': // do the backup of the db
    case 'backupDB': // do the backup of the db
      $file = ( $argc > 2 ) ? $argv[2].'.sql' : false;

      doBackup(Cogumelo::getSetupValue( 'db:name' ), Cogumelo::getSetupValue( 'db:user' ), Cogumelo::getSetupValue( 'db:password' ), $file);
      break;

    case 'restoreDB': // restore the backup of a given db
      if( $argc > 2 ) {
        $file = $argv[2];//name of the backup file
        restoreDB(Cogumelo::getSetupValue( 'db:name' ), Cogumelo::getSetupValue( 'db:user' ), Cogumelo::getSetupValue( 'db:password' ), $file);
      }
      else {
        echo "You must specify the file to restore\n";
      }
      break;

    case 'prepareDependences':
      Cogumelo::load('coreController/DependencesController.php');
      $dependencesControl = new DependencesController();
      $dependencesControl->prepareDependences();
      break;

    case 'updateDependences':
      Cogumelo::load('coreController/DependencesController.php');
      $dependencesControl = new DependencesController();
      $dependencesControl->installDependences();
      break;

    case 'installDependences':
      Cogumelo::load('coreController/DependencesController.php');
      $dependencesControl = new DependencesController();
      $dependencesControl->prepareDependences();

      Cogumelo::load('coreController/DependencesController.php');
      $dependencesControl = new DependencesController();
      $dependencesControl->installDependences();
      break;

    case 'generateFrameworkTranslations':
      Cogumelo::load('coreController/i18nScriptController.php');
      $i18nscriptController = new i18nScriptController();
      $i18nscriptController->setEnviroment();
      $i18nscriptController->c_i18n_getSystemTranslations();
      echo "The files.po are ready to be edited!\n";
      break;

    case 'generateAppTranslations':
      Cogumelo::load('coreController/i18nScriptController.php');
      $i18nscriptController = new i18nScriptController();
      $i18nscriptController->setEnviroment();
      $i18nscriptController->c_i18n_getAppTranslations();
      echo "The files.po are ready to be edited!\n";
      break;

    case 'generateModuleTranslations':
      Cogumelo::load('coreController/i18nScriptController.php');
      $i18nscriptController = new i18nScriptController();
      if( $argc > 2 ) {
        $res = $i18nscriptController->getAppModulePo($argv[2]);
        if($res){
          echo "The module.po are ready to be edited!\n";
        }
      }else{
        echo "You must specify the module\n";
      }
      break;

    case 'removeAllTranslations':
      Cogumelo::load('coreController/i18nScriptController.php');
      $i18nscriptController = new i18nScriptController();
      $i18nscriptController->c_i18n_removeTranslations();
      break;

    case 'precompileTranslations':
      actionPrecompileTranslations();
      break;

    case 'compileTranslations':
      actionCompileTranslations();
      break;

    case 'recompileTranslations':
      actionRecompileTranslations();
      break;

    case 'jsonTranslations':
      Cogumelo::load('coreController/i18nScriptController.php');
      $i18nscriptController = new i18nScriptController();
      $i18nscriptController->c_i18n_json();
      echo "The files.json are ready to be used!\n";
      break;

    /* We execute this two actions from web as we need to operate with the apache permissions*/
    case 'flush': // delete temporary files
      flushAll();
      echo "\n --- Flush DONE\n";
      break;

    // case 'rotateLogs':
    //   actionRotateLogs();
    //   break;

    case 'generateClientCaches':
      actionGenerateClientCaches();
      break;

    case 'loopCompileScss':
      setPermissions();
      loopCompileScss();
      break;


    default:
      echo "Invalid parameter;try:";
      printOptions();
      break;

  }//end switch
}//end parameters handler
else{
  echo "You have to write an option:";
  printOptions();
}


function printOptions(){
  echo "\n
 + Permissions and dependences
    * flush                   Remove temporary files
    * generateClientCaches    Cache all js, css, compiled less and other client files
    * loopCompileScss         Continuous scss compilation
    * setPermissions          Set the files/folders permission
    * setPermissionsDevel     Set the files/folders permission
    * installDependences      Exec prepareDependences and then exec updateDependences
      * prepareDependences      Generate JSON's dependences
      * updateDependences       Install all modules dependencies


 + Database
    * createDB                Create a database

    * generateModel           Initialize database

    * deploy                  Deploy

    * bckDB                   Do a DB backup (optional arg: filename)
    * restoreDB               Restore a database

 + Internationalization
  * generateFrameworkTranslations    Update text to translate in cogumelo and geozzy modules
   * generateAppTranslations    Get text to translate in the app
   * generateModuleTranslations    Get text to translate for a given module. Need to hand mix
   * precompileTranslations     Generate the intermediate POs(geozzy, cogumelo and app -> for testing!)
   * compileTranslations     Mix geozzy, cogumelo and app POS in one and compile it to get the translations the first time
   * recompileTranslations     Just make the modified PO compilation to get the MO file
  \n\n";
}

function actionPrecompileTranslations() {
  Cogumelo::load('coreController/i18nScriptController.php');
  $i18nscriptController = new i18nScriptController();
  $i18nscriptController->c_i18n_precompile();
  echo "\nThe intermediate .po are ready\n\n";
}

function actionCompileTranslations() {
  Cogumelo::load('coreController/i18nScriptController.php');
  $i18nscriptController = new i18nScriptController();
  /*$i18nscriptController->setEnviroment();*/
  $i18nscriptController->c_i18n_precompile();
  $i18nscriptController->c_i18n_compile();
  /* generate json for js */
  $i18nscriptController->c_i18n_json();
  echo "\nThe files.mo are ready to be used!\n\n";
}

function actionRecompileTranslations() {
  Cogumelo::load('coreController/i18nScriptController.php');
  $i18nscriptController = new i18nScriptController();
  $i18nscriptController->c_i18n_recompile();
  echo "\nThe files.mo are ready to be used!\n\n";
}

function generateModel() {
  $develdbcontrol = new DevelDBController();
  $develdbcontrol->scriptGenerateModel();
}

function deploy() {
  $develdbcontrol = new DevelDBController();
  $develdbcontrol->scriptDeploy();
}

function createRelSchemes() {
  echo "\nCreating relationship schemes\n";

  global $C_ENABLED_MODULES;

  foreach( $C_ENABLED_MODULES as $moduleName ) {
    require_once( ModuleController::getRealFilePath( $moduleName.'.php' , $moduleName) );
  }

  Cogumelo::load('coreModel/VOUtils.php');
  VOUtils::createModelRelTreeFiles();
}

function flushAll() {
  echo "\n --- setPermissionsDevel:\n";
  setPermissionsDevel();

  echo "\n --- actionFlush:\n";
  actionFlush();

  // echo "\n --- actionCompileTranslations:\n";
  // actionCompileTranslations();

  echo "\n --- actionGenerateClientCaches:\n";
  if( Cogumelo::getSetupValue( 'mod:mediaserver:productionMode' ) ) {
    actionGenerateClientCaches();
  }
  else {
    echo "\nPasamos porque no estamos en PRODUCTION MODE\n";
  }

  echo "\n --- setPermissionsDevel:\n";
  setPermissionsDevel();
}


function actionFlush() {

  // Def: app/tmp/templates_c
  rmdirRec( Cogumelo::getSetupValue('smarty:compilePath'), false );
  // Def: httpdocs/cgmlImg
  rmdirRec( Cogumelo::getSetupValue('mod:filedata:cachePath'), false );
  // Def: httpdocs/mediaCache
  rmdirRec( Cogumelo::getSetupValue('mod:mediaserver:tmpCachePath'), false );
  echo ' - Cogumelo File cache flush: Done'."\n";


  require_once( COGUMELO_LOCATION.'/coreClasses/coreController/Cache.php' );
  $cacheCtrl = new Cache();
  $cacheCtrl->flush();
  echo ' - Cogumelo Memory Cache flush: Done'."\n";


  $scriptCogumeloServerUrl = Cogumelo::getSetupValue( 'script:cogumeloServerUrl' );
  if( !empty( $scriptCogumeloServerUrl ) ) {
    echo ' - Cogumelo PHP cache flush...'."\n";

    // TODO: EVITAMOS CONTROLES HTTPS
    $contextOptions = stream_context_create( [
      "ssl" => [
        "verify_peer" => false,
        "verify_peer_name" => false,
      ],
    ] );
    echo file_get_contents( $scriptCogumeloServerUrl . '?q=flush', false, $contextOptions );
  }
  else {
    echo ' - Cogumelo PHP cache flush... Descartado.'."\n";
  }

  echo "\nCogumelo caches deleted!\n\n";
}


// function actionRotateLogs() {
//   echo file_get_contents( Cogumelo::getSetupValue( 'script:cogumeloServerUrl' ) . '?q=rotate_logs' );
//   echo "\nRotate Logs done!\n\n";
// }


function actionGenerateClientCaches() {


  require_once( ModuleController::getRealFilePath( 'mediaserver.php', 'mediaserver' ) );
  mediaserver::autoIncludes();
  CacheUtilsController::generateAllCaches();


  // $ctx = stream_context_create( ['http'=> ['timeout' => 1200 ] ] ); //1200 Seconds is 20 Minutes
  // echo("Calling ".Cogumelo::getSetupValue( 'script:cogumeloServerUrl' ) . '?q=client_caches ... If you have any problem in less compilation, execute this url in browser');
  // file_get_contents( Cogumelo::getSetupValue( 'script:cogumeloServerUrl' ) . '?q=client_caches', false, $ctx);


  echo "\nClient caches generated\n\n";
}


function loopCompileScss() {
  while(1) {
    setPermissions(true);
    system('clear');
    require_once( ModuleController::getRealFilePath( 'mediaserver.php', 'mediaserver' ) );
    mediaserver::autoIncludes();
    CacheUtilsController::generateAllCaches();
    //CacheUtilsController::generateAllScssCaches();
    sleep(3);
  }
}


function createDB(){

  echo "\nDatabase configuration\n";

  $user = false;

  $fileConnectionsInfo = APP_BASE_PATH.'/conf/inc/default-connections-info.php';
  if( file_exists( $fileConnectionsInfo ) ) {
    include $fileConnectionsInfo;
    if( defined( 'DDBB_PRIV_USER' ) && defined( 'DDBB_PRIV_PASS' ) ) {
      $user = DDBB_PRIV_USER;
      $passwd = DDBB_PRIV_PASS;
    }
  }

  if( !$user ) {
    $user = ReadStdin( "Enter an user with privileges:\n", '' );
    fwrite( STDOUT, "Enter the password:\n" );
    $passwd = getPassword( true );
    fwrite( STDOUT, "\n--\n" );
  }


  $develdbcontrol = new DevelDBController( $user, $passwd );
  $develdbcontrol->createSchemaDB();
  echo "\nDatase created!\n";
}



function makeAppPaths() {
  global $lc;
  $md = array( APP_TMP_PATH,
    Cogumelo::getSetupValue( 'smarty:configPath' ), Cogumelo::getSetupValue( 'smarty:compilePath' ),
    Cogumelo::getSetupValue( 'smarty:cachePath' ), Cogumelo::getSetupValue( 'smarty:tmpPath' ),
    Cogumelo::getSetupValue( 'mod:mediaserver:tmpCachePath' ),
    // WEB_BASE_PATH.'/'.Cogumelo::getSetupValue( 'mod:mediaserver:path' ),
    WEB_BASE_PATH.'/'.Cogumelo::getSetupValue( 'mod:mediaserver:cachePath' ),
    Cogumelo::getSetupValue( 'logs:path' ),
    Cogumelo::getSetupValue( 'session:savePath' ),
    Cogumelo::getSetupValue( 'mod:form:tmpPath' ),
    Cogumelo::getSetupValue( 'mod:filedata:filePath' ),
    Cogumelo::getSetupValue( 'mod:filedata:cachePath' ),
    Cogumelo::getSetupValue( 'script:backupPath' ),
    Cogumelo::getSetupValue( 'i18n:path' ), Cogumelo::getSetupValue( 'i18n:localePath' )
  );

  foreach( Cogumelo::getSetupValue( 'lang:available' ) as $lang ) {
    $md[] = Cogumelo::getSetupValue( 'i18n:localePath' ).'/'.$lang['i18n'].'/LC_MESSAGES';
  }

  foreach( $md as $dir ) {
    if( $dir && $dir !== '' && !is_dir( $dir ) ) {
      if( !mkdir( $dir, 0777, true ) ) {
        echo 'ERROR: Imposible crear el dirirectorio: '.$dir."\n";
      }
    }
  }
}

function setPermissions( $devel = false ) {
  makeAppPaths();

  $extPerms = $devel ? ',ugo+rX' : '';

  exec( 'sudo chown -R $USER:www-data '.
    WEB_BASE_PATH.' '.APP_BASE_PATH.' '.APP_TMP_PATH.' '.
    Cogumelo::getSetupValue( 'smarty:configPath' ).' '.Cogumelo::getSetupValue( 'smarty:compilePath' ).' '.
    Cogumelo::getSetupValue( 'smarty:cachePath' ).' '.Cogumelo::getSetupValue( 'smarty:tmpPath' ).' '.
    Cogumelo::getSetupValue( 'mod:mediaserver:tmpCachePath' ).' '.
    // WEB_BASE_PATH.'/'.Cogumelo::getSetupValue( 'mod:mediaserver:path' ).' '.
    WEB_BASE_PATH.'/'.Cogumelo::getSetupValue( 'mod:mediaserver:cachePath' ).' '.
    Cogumelo::getSetupValue( 'logs:path' ).' '.
    Cogumelo::getSetupValue( 'mod:form:tmpPath' ).' '.
    Cogumelo::getSetupValue( 'mod:filedata:filePath' ).' '.
    Cogumelo::getSetupValue( 'i18n:path' ).' '.Cogumelo::getSetupValue( 'i18n:localePath' )
  );

  exec( 'chmod -R go-rwx,g+rX'.$extPerms.' '.WEB_BASE_PATH );

  exec( 'chmod -R go-rwx,g+rX'.$extPerms.' '.APP_BASE_PATH );

  // Path que necesitan escritura Apache
  exec( 'chmod -R ug+rwX'.$extPerms.' '.APP_TMP_PATH.' '.
    Cogumelo::getSetupValue( 'smarty:configPath' ).' '.Cogumelo::getSetupValue( 'smarty:compilePath' ).' '.
    Cogumelo::getSetupValue( 'smarty:cachePath' ).' '.Cogumelo::getSetupValue( 'smarty:tmpPath' ).' '.
    Cogumelo::getSetupValue( 'mod:mediaserver:tmpCachePath' ).' '.
    // WEB_BASE_PATH.'/'.Cogumelo::getSetupValue( 'mod:mediaserver:path' ).' '.
    WEB_BASE_PATH.'/'.Cogumelo::getSetupValue( 'mod:mediaserver:cachePath' ).' '.
    Cogumelo::getSetupValue( 'logs:path' ).' '.
    Cogumelo::getSetupValue( 'session:savePath' ).' '.
    Cogumelo::getSetupValue( 'mod:form:tmpPath' ).' '.
    Cogumelo::getSetupValue( 'mod:filedata:filePath' ).' '.
    Cogumelo::getSetupValue( 'mod:filedata:cachePath' ).' '.
    Cogumelo::getSetupValue( 'i18n:path' ).' '.Cogumelo::getSetupValue( 'i18n:localePath' )
  );

  // session:savePath tiene que mantener el usuario y grupo
  $sessionSavePath = Cogumelo::getSetupValue( 'session:savePath' );
  if( !empty($sessionSavePath) ) {
    exec( 'sudo chown -R www-data:www-data '.Cogumelo::getSetupValue( 'session:savePath' ) );
  }

  // Solo usuario administrador
  exec( 'sudo chown $USER:$USER '.Cogumelo::getSetupValue( 'script:backupPath' ) );
  exec( 'chmod -R go-rwx '.Cogumelo::getSetupValue( 'script:backupPath' ) );

  echo "Permissions ready!\n";
}

function setPermissionsDevel() {
  setPermissions( true );
}


function doBackup( $db, $user, $passwd, $file ) {
  if( !$file ) {
    $file = date('Ymd-His').'-'.$db.'.sql';
  }

  $dir = Cogumelo::getSetupValue( 'script:backupPath' );

  popen( 'mysqldump --hex-blob --complete-insert --skip-extended-insert -u ' . $user . ' -p' . $passwd .' '. $db . '> ' . $dir . '/' . $file, 'r' );
  exec( 'gzip ' . $dir . '/' . $file );
  exec( 'chmod go-rwx ' . $dir . '/' . $file . '*' );
  echo "\nYour db was successfully saved!\n";
}

function restoreDB( $db, $user, $passwd, $file ) {
  $dir = Cogumelo::getSetupValue( 'script:backupPath' );

  // $file_parts = explode('.',$dir.$file);
  $fileExt = pathinfo( $dir.$file, PATHINFO_EXTENSION );

  // if ($file_parts[2] == 'gz'){
  if( $fileExt === 'gz' ) {
    popen('gunzip -c '.$dir.$file.' | mysql -u '.$user.' -p'.$passwd.' '.$db, 'r');
  }
  else {
    popen('mysql -u '.$user.' -p'.$passwd.' '.$db.'<' .$dir.$file, 'r');
  }
  echo "\nYour db was successfully restored!\n";
}

/**
 * Get data from the shell.
 */
function ReadStdin( $prompt, $valid_inputs, $default = '' ) {
  while( !isset($input) || ( is_array($valid_inputs) && !in_array($input, $valid_inputs) ) || ( $valid_inputs === 'is_file' && !is_file($input) ) ) {
    echo $prompt;
    $input = strtolower(trim(fgets(STDIN)));
    if( empty($input) && !empty($default) ) {
      $input = $default;
    }
  }
  return $input;
}

/**
 * Get a password from the shell.
 * This function works on *nix systems only and requires shell_exec and stty.
 *
 * @param boolean $stars Wether or not to output stars for given characters
 *
 * @return string
 */
function getPassword( $stars = false ) {
  // Get current style
  $oldStyle = shell_exec('stty -g');

  if ($stars === false) {
    shell_exec('stty -echo');
    $password = rtrim(fgets(STDIN), "\n");
  }
  else {
    shell_exec('stty -icanon -echo min 1 time 0');

    $password = '';

    while( true ) {
      $char = fgetc( STDIN );

      if( $char === "\n" ) {
        break;
      }
      elseif( ord($char) === 127 ) {
        if( strlen($password) > 0 ) {
          fwrite( STDOUT, "\x08 \x08" );
          $password = substr( $password, 0, -1 );
        }
      }
      else {
        fwrite( STDOUT, "*" );
        $password .= $char;
      }
    }
  }

  // Reset old style
  shell_exec('stty ' . $oldStyle);

  // Return the password
  return $password;
}


function rmdirRec( $dir, $removeContainer = true ) {
  // error_log( "rmdirRec( $dir )" );

  $dir = rtrim( $dir, '/' );
  if( !empty( $dir ) && strpos( $dir, PRJ_BASE_PATH ) === 0 && is_dir( $dir ) ) {
    $dirElements = scandir( $dir );
    if( !empty( $dirElements ) ) {
      foreach( $dirElements as $object ) {
        if( $object !== '.' && $object !== '..' ) {
          if( is_dir( $dir.'/'.$object ) ) {

            rmdirRec( $dir.'/'.$object );
          }
          else {

            unlink( $dir.'/'.$object );
          }
        }
      }
    }
    reset( $dirElements );
    if( $removeContainer ) {
      if( !is_link( $dir ) ) {
        rmdir( $dir );
      }
      else {
        unlink( $dir );
      }
    }
  }
}
